<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>StickPoser Prototype 3.1</title>
    <script type="text/javascript" src="http://code.jquery.com/jquery.min.js"></script>
    <script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/kinetic-v4.5.5.min.js"></script>
    
    <script type="text/javascript" src="PoseFigure.js"></script>
    <script type="text/javascript" src="PosePart.js"></script>
    <script type="text/javascript" src="PoseFile.js"></script>
    


<style type="text/css">
#container{
	border:solid 1px #ccc;
	margin-top: 10px;
	width:600px;
	height:600px;
	float:left;
}

#exportedImageDiv{
	xxdisplay:none;
}

#downloadImage{
	margin-left: 160px;
}

#saveImageDiv{
	display: inline;
	margin-left: 320px;
}

#control{
	clear: both;
}


.menuItem {
	-webkit-box-shadow:rgba(0,0,0,0.0.1) 0 1px 0 0;
	-moz-box-shadow:rgba(0,0,0,0.0.1) 0 1px 0 0;
	box-shadow:rgba(0,0,0,0.0.1) 0 1px 0 0;
	background-color:#5B74A8;
	border:1px solid #29447E;
	font-family:'Lucida Grande',Tahoma,Verdana,Arial,sans-serif;
	font-size:12px;
	font-weight:700;
	padding:2px 6px;
	height:28px;
	color:#fff;
	border-radius:5px;
	-moz-border-radius:5px;
	-webkit-border-radius:5px;
	cursor:pointer;
}

</style>        
<script>

var figure;
var layerParts,
    layerPoints;
var activePartIndex;
var isPart;
    	
$(document).ready(function(){

	makeControls();

	var stage = new Kinetic.Stage({
        container: 'container',
        width: 600,
        height: 600
    });

    layerParts = new Kinetic.Layer();
    layerPoints = new Kinetic.Layer();
    stage.add(layerParts);
    stage.add(layerPoints);   
    
    $(".menu_content").hide();
  	$("#draw").show();
  	
    $(".menuItem").on("click", function(){
    	$(".menu_content").hide();
    	var showThis = $(this).attr("id").substring(5);
    	$("#" + showThis).show();
    });
        
    $("#container").on("click", function(){
    
    	clickTimer = setTimeout(function(){
			if(!isPart){
				layerPoints.clear();				
			}
			isPart = false;
    	}, 500);
    
    });
    
	$(".btnRound").on("click", function(){
		var tens = $(this).val();

		figure.GetParts()[activePartIndex].SetTension(parseFloat(tens));
	});
	
	$(".btnNumMid").on("click", function(){
		var num = $(this).val();

		figure.GetParts()[activePartIndex].SetNumMidPts(parseInt(num), layerPoints);
	}); 
	
	$("#nextSlide").click(function() {
		var nextSlide = $(this).attr("data-slide");
		$("#slide").attr("src", "/instructions/Slide" + nextSlide + ".gif");
		nextSlide = parseInt(nextSlide) + 1;
		nextSlide = (nextSlide > 9 ? 1 : nextSlide);
		$(this).attr("data-slide", nextSlide);
	});
	
	$("#exportImage").on("click", function(){
		stage.toDataURL({
			callback: function(dataUrl) {
				 // This forces download when navigated to
				// var downloadUrl = dataUrl.replace(/^data:image\/[^;]/, 'data:application/octet-stream');
				 var downloadUrl = dataUrl.replace(/^data:image\/[^;]/, 'data:image/octet-stream');
				 console.log(downloadUrl);
				 
				 $("#exportedImageDiv").show();
				 $("#exportedImage").attr("src", dataUrl);
				 $("#downloadImage").click(function(event) {
					// This will cause download
					location.href = downloadUrl;
				 });
			}
        });
		stage.toDataURL();
	});  
	
	$("#getFile").on("click", function(){
		var txt = "";
		var name = prompt("Enter Name");
		if(name){
			txt = figure.Write(name);
			$("#writeFile").text(txt);
		}
	});  
	
	$("#poses").on("change", function(){
    	figure = new PoseFigure(Pose[this.value]);
    	figure.Draw(layerParts, layerPoints);	
	});

    figure = new PoseFigure(Pose["BASE"]);
    figure.Draw(layerParts, layerPoints);	

});

function RedrawFigure(diffInMotion){
	figure.Draw(layerParts, layerPoints, diffInMotion);
}

function SetActivePart(part_idx){
	activePartIndex = part_idx;
	isPart = true;
//console.log("new part index", part_idx);

}

function makeControls(){

	$.each(Pose, function(idx, pose){
		$('<option>').val(idx).text(idx).appendTo('#poses');
	});
}

</script>       
</head>

<body>
	<div id="menu">
		<span id='menu_draw' class='menuItem'>Draw</span>
		<span id='menu_guide' class='menuItem'>Guide</span>
		<span id='menu_save' class='menuItem'>Save</span>
	</div>
	
	<div id="draw" class="menu_content">
		<div id="container"></div>
		<div id="control">
			Select Pose: <select id="poses"></select>
			<div id="saveImageDiv">
				<input type="button" id="exportImage" value="Export Image"></input>
			</div>
			<br/>Roundness:
			<input id="tens" value="1.0" size="6"></input>
			<input type="button" class="btnRound" value="1.0" ></input>
			<input type="button" class="btnRound" value="0.8" ></input>
			<input type="button" class="btnRound" value="0.6" ></input>
			<input type="button" class="btnRound" value="0.4" ></input>
			<input type="button" class="btnRound" value="0.2" ></input>
			<input type="button" class="btnRound" value="0.0" ></input>
			<br/>Number Mid Points:
			<input type="button" class="btnNumMid" value="1" ></input>
			<input type="button" class="btnNumMid" value="2" ></input>
			<input type="button" class="btnNumMid" value="3" ></input>
			<input type="button" class="btnNumMid" value="4" ></input>
			<input type="button" class="btnNumMid" value="5" ></input>
			<input type="button" class="btnNumMid" value="6" ></input> 
		
		</div>	
    </div>
	
	<div id="guide" class="menu_content">
		<img id="slide" src="/instructions/Slide1.gif" style="width:800px">
		<img id="nextSlide" src="Next Arrow.png" data-slide="2" style="cursor:pointer">
	</div>
    
    
    <div id="save" class="menu_content">
		
		<div id="exportedImageDiv">
			<img id="exportedImage" src="" download="stickposer.png">
			<br/>
			<input type="button" id="downloadImage" value="Download Image"></input>
			Note: Open in an image program.
		</div>

		<br/>Get Pose File Text: 
    	<input type="button" id="getFile" value="Get File"></input> 
    	<br/><textarea id="writeFile"></textarea> 
    	<br/>Note: Copy and Paste code into PoseFile.js.	
    	
		<p>
			Other Useful Resources:
			<br/><a href="/RicksSticks.pdf" target="_blank">Rick's Sticks Instructions (pdf)</a>
			<br/><a href="http://inkscape.org/download/" target="_blank">Download Inkscape</a></p>
	</div>
	
</body>
